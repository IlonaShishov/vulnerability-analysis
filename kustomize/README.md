# Procedure to Deploy

1. Set all your api keys and tokens in the following command. Note that all the keys are not required.
Look at this [Readme](../README.md) for more details.

```shell
cat > base/secrets.env << EOF
nvd_api_key=you_api_key
serpapi_api_key=your_api_key
tavily_api_key=your_api_key
nvidia_api_key=your_api_key
ghsa_api_key=your_api_key
ngc_api_key=your_api_key
EOF
```

2. If you don't have namespace , create it
```shell
export YOUR_NAMESPACE_NAME=yourNamespaceNameHere
oc new-project $YOUR_NAMESPACE_NAME
```

3. Create an image pull secret that is authorized to pull agent morpheus image:      
```shell
oc create secret generic morpheus-pull-secret --from-file=.dockerconfigjson=<path/to/.docker/config.json> --type=kubernetes.io/dockerconfigjson
```

4. Create an image pull secret that is authorized to pull images from ngrc.io:      
```shell
oc create secret generic ngc-secret --from-file=.dockerconfigjson=<path/to/.docker/config.json> --type=kubernetes.io/dockerconfigjson
```

5. Deploy agent-morpheus + agent-morpheus-client to your namespace. The default configuration will use local embeddings and remote NIM LLM
```shell
oc kustomize base |  oc apply -f - -n $YOUR_NAMESPACE_NAME
```

6. Alternatively, if you want to deploy agent-morpheus with our self-hosted LLM or fully remote services, then run
```shell
# Deploy agent morpheus with local llama3.1 LLM 
oc kustomize overlays/local-llama3.1-70b-4bit |  oc apply -f - -n $YOUR_NAMESPACE_NAME
# Deploy agent morpheus with remote llama-3.1-70b-4bit LLM
oc kustomize overlays/remote-nim-all |  oc apply -f - -n $YOUR_NAMESPACE_NAME
```
7. If you didn't deploy yet self-hosted embedding model and one of the above LLMs, first fetch latest version of agent-morpheus git submodule
```shell
git submodule init --recursive
git submodule update --merge --recursive
# Or if the local submodule sha is not updated to latest one, you can fetch it from remote tracking branch
git submodule update --remote --merge --recursive
```
8. Follow the instructions below 
    1. from your local repository
       ```shell
       cd ../agent-morpheus-models    
        ```
       [open instructions locally](../agent-morpheus-models/README.md)
   2. [Open instruction in browser](https://github.com/RHEcosystemAppEng/agent-morpheus-models)

## Developer Overlay

This Overlay intended usage is to speed up development and testing new changes/features applied to 
agent morpheus, enabling testing rapidly changes in agent-morpheus on cluster, without having to wait for the new image build with done changes.
This overlay enforce invoking the LLM on every invocation, in order to guarantee that every change will propagate to LLM and will
cause the LLM to produce a different output, and not cached version output from the llm cache in nginx.

9. Perform Steps 1-3 On a new namespace
10. For enabling LANGSMITH traces ( very useful for debugging), input your Langchain API Key:
```shell
 echo "langchainApiKey=YOUR_API_KEY_GOES_HERE" > overlays/developer/langsmith-secret.env
```
11. Deploy agent-morpheus developer mode
```shell
kustomize build overlays/developer/  | oc apply -f -
```

12. Run Agent morpheus first time and verify it's working ( in a new terminal `agent-morpheus`)
```shell
# enter agent morpheus pod in a new bash shell process
oc exec -it $(oc get pods -o=name -l component=agent-morpheus-rh ) -- bash
# run agent morpheus inside the pod
eval $AGENT_MORPHEUS_PYTHON_COMMAND
```
Output:
```shell
Http Server Started for POST at 0.0.0.0:8080
                            /scan.
====Pipeline Pre-build====
====Pre-Building Segment: linear_segment_0====
====Pre-Building Segment Complete!====
====Pipeline Pre-build Complete!====
====Registering Pipeline====
====Building Pipeline====
====Building Pipeline Complete!====
Source: 0 messages [00:00, ? messages====Registering Pipeline Complete!====
====Starting Pipeline==== messages/s]
====Pipeline Started====
====Building Segment: linear_segment_0====
Added source: <from-cve-http-0; PydanticHttpStage(bind_address=0.0.0.0, port=8080, endpoint=/scan, method=HTTPMethod.POST, accept_status=201, sleep_time=0.1, queue_timeout=5, max_queue_size=None, num_server_threads=None, max_payload_size=10, request_timeout_secs=30, lines=False, stop_after=0, input_schema=<class 'src.cve.data_models.input.AgentMorpheusInput'>)>
  └─> src.AgentMorpheusInput
Added stage: <print_payload-1; WrappedFunctionStage(name=print_payload, on_data_fn=functools.partial(<function build_http_input.<locals>.print_payload at 0x7f416b164280>), accept_type=typing.Any, compute_schema_fn=<function stage.<locals>.wrapper.<locals>.compute_schema_fn_inner at 0x7f416b1643a0>, needed_columns=None, execution_modes=(<ExecutionMode.GPU: 'GPU'>,))>
  └─ src.AgentMorpheusInput -> src.AgentMorpheusInput
Added stage: <build-source-code-vdb-stage-2; BuildSourceCodeVdbStage(build_vdb_fn=<bound method DocumentEmbedding.build_vdbs of <src.cve.utils.document_embedding.DocumentEmbedding object at 0x7f416b140130>>, ignore_errors=False, ignore_code_embedding=False)>
  └─ src.AgentMorpheusInput -> src.AgentMorpheusEngineInput
Added stage: <fetch_intel-3; WrappedFunctionStage(name=fetch_intel, on_data_fn=functools.partial(<function build_input.<locals>.fetch_intel at 0x7f416b164310>), accept_type=<class 'src.cve.data_models.input.AgentMorpheusEngineInput'>, compute_schema_fn=<function stage.<locals>.wrapper.<locals>.compute_schema_fn_inner at 0x7f416a4767a0>, needed_columns=None, execution_modes=(<ExecutionMode.GPU: 'GPU'>,))>
  └─ src.AgentMorpheusEngineInput -> src.AgentMorpheusEngineInput
Added stage: <process_sbom-4; WrappedFunctionStage(name=process_sbom, on_data_fn=functools.partial(<function build_input.<locals>.process_sbom at 0x7f416a4770a0>), accept_type=<class 'src.cve.data_models.input.AgentMorpheusEngineInput'>, compute_schema_fn=<function stage.<locals>.wrapper.<locals>.compute_schema_fn_inner at 0x7f416a477880>, needed_columns=None, execution_modes=(<ExecutionMode.GPU: 'GPU'>,))>
  └─ src.AgentMorpheusEngineInput -> src.AgentMorpheusEngineInput
Added stage: <check_vulnerable_dependencies-5; WrappedFunctionStage(name=check_vulnerable_dependencies, on_data_fn=functools.partial(<function build_input.<locals>.check_vulnerable_dependencies at 0x7f416a477910>), accept_type=<class 'src.cve.data_models.input.AgentMorpheusEngineInput'>, compute_schema_fn=<function stage.<locals>.wrapper.<locals>.compute_schema_fn_inner at 0x7f416a477a30>, needed_columns=None, execution_modes=(<ExecutionMode.GPU: 'GPU'>,))>
  └─ src.AgentMorpheusEngineInput -> src.AgentMorpheusEngineInput
Added stage: <convert_input_to_df-6; WrappedFunctionStage(name=convert_input_to_df, on_data_fn=functools.partial(<function build_pipeline_without_sink.<locals>.convert_input_to_df at 0x7f4169d9a290>), accept_type=<class 'src.cve.data_models.input.AgentMorpheusEngineInput'>, compute_schema_fn=<function stage.<locals>.wrapper.<locals>.compute_schema_fn_inner at 0x7f4169d9a3b0>, needed_columns=None, execution_modes=(<ExecutionMode.GPU: 'GPU'>,))>
  └─ src.AgentMorpheusEngineInput -> morpheus.ControlMessage
Added stage: <add_start_timestamp-7; WrappedFunctionStage(name=add_start_timestamp, on_data_fn=functools.partial(<function build_pipeline_without_sink.<locals>.add_start_timestamp at 0x7f4169d9a440>), accept_type=<class 'morpheus.messages.control_message.ControlMessage'>, compute_schema_fn=<function stage.<locals>.wrapper.<locals>.compute_schema_fn_inner at 0x7f4169d9a680>, needed_columns=None, execution_modes=(<ExecutionMode.GPU: 'GPU'>,))>
  └─ morpheus.ControlMessage -> morpheus.ControlMessage
Added stage: <monitor-8; MonitorStage(description=Source, smoothing=0.05, unit=messages, delayed_start=False, determine_count_fn=None, log_level=LogLevels.INFO)>
  └─ morpheus.ControlMessage -> morpheus.ControlMessage
Added stage: <llm-engine-9; LLMEngineStage(engine=<morpheus_llm._lib.llm.LLMEngine object at 0x7f4169e0b9f0>)>
  └─ morpheus.ControlMessage -> morpheus.ControlMessage
Added stage: <add_end_timestamp-10; WrappedFunctionStage(name=add_end_timestamp, on_data_fn=functools.partial(<function build_pipeline_without_sink.<locals>.add_end_timestamp at 0x7f4169d9a710>), accept_type=<class 'morpheus.messages.control_message.ControlMessage'>, compute_schema_fn=<function stage.<locals>.wrapper.<locals>.compute_schema_fn_inner at 0x7f4169d9a830>, needed_columns=None, execution_modes=(<ExecutionMode.GPU: 'GPU'>,))>
  └─ morpheus.ControlMessage -> morpheus.ControlMessage
Added stage: <monitor-11; MonitorStage(description=LLM, smoothing=0.05, unit=messages, delayed_start=False, determine_count_fn=None, log_level=LogLevels.INFO)>
  └─ morpheus.ControlMessage -> morpheus.ControlMessage
Added stage: <convert_to_output_object-12; WrappedFunctionStage(name=convert_to_output_object, on_data_fn=functools.partial(<function convert_to_output_object at 0x7f41846d68c0>), accept_type=<class 'morpheus.messages.control_message.ControlMessage'>, compute_schema_fn=<function stage.<locals>.wrapper.<locals>.compute_schema_fn_inner at 0x7f4169d9a8c0>, needed_columns=None, execution_modes=(<ExecutionMode.GPU: 'GPU'>,))>
  └─ morpheus.ControlMessage -> src.AgentMorpheusOutput
Added stage: <http_callback_stage-13; WrappedFunctionStage(name=http_callback_stage, on_data_fn=functools.partial(<function HttpOutputPlugin.build_output.<locals>.http_callback_stage at 0x7f4169d9a7a0>), accept_type=<class 'src.cve.data_models.output.AgentMorpheusOutput'>, compute_schema_fn=<function stage.<locals>.wrapper.<locals>.compute_schema_fn_inner at 0x7f4169d9b1c0>, needed_columns=None, execution_modes=(<ExecutionMode.GPU: 'GPU'>,))>
  └─ src.AgentMorpheusOutput -> src.AgentMorpheusOutput
====Building Segment Complete!====
Source: 0 messages [00:13, ? messages/s]
LLM: 0 messages [00:13, ? messages/s]
```

13. Change something in agent-morpheus, and make sure that it's the only change appears, to make sure that irrelevant changes won't intrude into the pod before testing
```shell
git diff
```
Expected Output example:
![img.png](img.png)

14. Now, That you're seeing your modification, and this is what you want to test in cluster,
    synchronize agent morpheus pod with agent-morpheus repo, to copy all changes from your local git worktree/index to the agent-morpheus-rh pod
```shell
# you must be in some path in the repo so it will work
 oc rsync $(git rev-parse --show-toplevel) $(oc get pods -o=name -l component=agent-morpheus-rh ):.
```
15. Now, after fix/feature propagated completely to the pod, go back the terminal windows `agent-morpheus` ( from section 12), and press CTRL + C shortcut to gracefully shut down agent-morpheus.
Expected output:
```shell
Stopping pipeline. Please wait... Press Ctrl+C again to kill.
Source: 0 messages [11:33, ? messages====Stopping Pipeline====
Stopping from-cve-http, ? messages/s]
====Pipeline Stopped====
Source[Complete]: 0 messages [00:00, ? messages/s]
LLM[Complete]: 0 messages [00:00, ? messages/s]
====Pipeline Complete====
Total time: 701.99 sec
Pipeline runtime: 694.18 sec
```
16. In the same shell, Run again agent-morpheus in order to take new changes in pod' container filesystem
```shell
eval $AGENT_MORPHEUS_PYTHON_COMMAND
```
OK, Now you're ready to send requests ( manually or using agent-morpheus-client) in order to test your fix/feature!.
Pay attention, now every subsequent change that you'd like to test, requires you only to repeat steps 13-16( including the coding itself, done very quickly) 

17. When finishing, and wants to save resources, clean up:
```shell
# Delete all resources but keep all data saved in PVCs
kustomize build overlays/developer/  | oc delete -l purpose!=persistent -f -
# Or, Delete Everything
kustomize build overlays/developer/  | oc delete -f -
```