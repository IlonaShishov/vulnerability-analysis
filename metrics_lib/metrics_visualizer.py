import os
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt

class MetricsVisualizer:

    def __init__(self, metrics_data, report_name):
        self.report_name = report_name
        self.metrics_data = metrics_data

        self.melted_metrics_data = self.metrics_data.melt(id_vars=["ID"], var_name="Metric", value_name="Score")
        self.plot_dir = self._get_plot_dir()
        
        self._create_plot_dir()

    def _get_plot_dir(self):
        report_name_as_dir = self.report_name.replace(' ','_').lower()
        plot_dir = os.path.join('.', 'plots', report_name_as_dir)
        return plot_dir

    def _create_plot_dir(self):
        os.makedirs(self.plot_dir, exist_ok=True)

    def plot_heatmap(self):
        plot_path = os.path.join(self.plot_dir, 'heatmap_plot.png')
        plt.figure()
        sns.heatmap(
            data=self.metrics_data.set_index("ID"), 
            annot=True, 
            cmap='coolwarm_r', 
            vmin=0, 
            vmax=1, 
            fmt=".2f"
        )
        plt.title("Heatmap of Scores Across Use Cases")
        plt.savefig(plot_path, bbox_inches="tight")
        plt.close()

    def plot_lineplot(self):
        plot_path = os.path.join(self.plot_dir, 'lineplot_plot.png')
        plt.figure()
        sns.lineplot(
            x="ID", 
            y="Score", 
            hue="Metric", 
            data=self.melted_metrics_data, 
            marker="o", 
            palette="tab10"
        )
        plt.title("Metric Trends Across Use Cases")
        plt.xticks(rotation=90)
        plt.legend(bbox_to_anchor=(1.05, 1), loc='upper left')
        plt.savefig(plot_path, bbox_inches="tight")
        plt.close()