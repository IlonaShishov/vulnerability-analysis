
class JustificationLabelMetrics:

    JUSTIFICATION_PROMPT = """
        The summary provided below (delimited with XML tags), generated by the software agent named Vulnerability
        Analysis for Container Security, evaluates a specific CVE (Common Vulnerabilities and Exposures) against the
        backdrop of a software package or environment information. This information may include a Software Bill of
        Materials (SBOM), source code, and dependency documentation among others related to environments such as
        container images. Vulnerability Analysis for Container Security's role is to analyze this data to ascertain if the CVE
        impacts the software environment, determining the necessity for a patch.

        Your task is to review Vulnerability Analysis for Container Security's analysis and classify the situation into
        one of the following categories based on the described scenario:
        - false_positive: The association between the software package and the CVE is incorrect, either due to an
        erroneous package identification or a mismatched CVE.
        - code_not_present: The software product is unaffected as it does not contain the code or library that harbors
        the vulnerability.
        - code_not_reachable: During runtime, the vulnerable code is not executed.
        - requires_configuration: The exploitability of this issue depends on whether a specific configuration option is
        enabled or disabled. In this case, the configuration is set in a manner that prevents exploitability.
        - requires_dependency: Exploitability is contingent upon a missing dependency.
        - requires_environment: A specific environment, absent in this case, is required for exploitability.
        - compiler_protected: Exploitability hinges on the setting or unsetting of a compiler flag. In this case, the
        flag is set in a manner that prevents exploitability.
        - runtime_protected: Mechanisms are in place that prevent exploits during runtime.
        - perimeter_protected: Protective measures block attacks at the physical, logical, or network perimeters.
        - mitigating_control_protected: Implemented controls mitigate the likelihood or impact of the vulnerability.
        - uncertain: Not enough information to determine the package's exploitability status.
        - vulnerable: the package is actually vulnerable to the CVE and needs to be patched.

        Response only with the category name.
        <summary>{{summary}}</summary>
        """
 
    def __init__(self):

        self.metrics = {
            "Faithfulness": {},
            "ResponseRelevancy": {},
            "SummarizationScore": {},
            "AspectCritic_representativeness": { 
                "name": "aspect_critic_representativeness" , 
                "definition": "Does the submission accurately reflect the core content and main idea of the summary?"
            },
            "AspectCritic_relevance": { 
                "name": "aspect_critic_relevance" , 
                "definition": "Is the submission highly relevant to the summary, focusing on its most important aspects?"
            },
            "AspectCritic_validity": { 
                "name": "aspect_critic_validity" , 
                "definition": "Is the label chosen from the predefined list of valid labels?"
            }
        }

    def get_datasets(self, data):
        datasets = {}
        for case_id, outputs in data.items():
            dataset = []
            for output in outputs:    
                checklist_lst = [item["response"] for item in output["checklist"]]
                justification_label = output["justification"]["label"]
                summary = output["summary"]
                data = {
                    "user_input": self.JUSTIFICATION_PROMPT.format(summary=summary),
                    "response": justification_label,
                    "reference": summary,
                    "reference_contexts": [summary],
                    "retrieved_contexts": checklist_lst
                }
                dataset.append(data)
            datasets[case_id] = dataset
        return datasets
